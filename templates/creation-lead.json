{
  "id": "YfoDYZpdsWywolKj2fOWJ",
  "name": "Creation Lead",
  "description": "",
  "tags": [],
  "pieces": [
    "@tuyendaovan6789/piece-pipedrive",
    "@activepieces/piece-postgres"
  ],
  "pinnedOrder": null,
  "blogUrl": "",
  "template": {
    "displayName": "Creation Lead",
    "trigger": {
      "name": "trigger",
      "valid": true,
      "displayName": "webhook trigger - created workspace",
      "nextAction": {
        "name": "step_1",
        "type": "CODE",
        "valid": true,
        "settings": {
          "input": {
            "body": "{{trigger['body']}}"
          },
          "inputUiInfo": {},
          "artifact": "UEsDBAoAAAAAAGqPM1fL6P4yTwAAAE8AAAAIAAAAaW5kZXgudHNleHBvcnQgY29uc3QgY29kZSA9IGFzeW5jIChpbnB1dHMpID0+IHsKICAgIHJldHVybiBKU09OLnBhcnNlKGlucHV0cy5ib2R5KTsKfTsKUEsDBAoAAAAAAGqPM1caUtEIHAAAABwAAAAMAAAAcGFja2FnZS5qc29uewogICJkZXBlbmRlbmNpZXMiOiB7CiAgfQp9ClBLAQIUAAoAAAAAAGqPM1fL6P4yTwAAAE8AAAAIAAAAAAAAAAAAAAAAAAAAAABpbmRleC50c1BLAQIUAAoAAAAAAGqPM1caUtEIHAAAABwAAAAMAAAAAAAAAAAAAAAAAHUAAABwYWNrYWdlLmpzb25QSwUGAAAAAAIAAgBwAAAAuwAAAAAA"
        },
        "nextAction": {
          "name": "step_15",
          "type": "BRANCH",
          "valid": true,
          "settings": {
            "conditions": [
              [
                {
                  "operator": "TEXT_DOES_NOT_CONTAIN",
                  "firstValue": "{{step_1['__op']}}",
                  "secondValue": "d",
                  "caseSensitive": false
                }
              ]
            ],
            "inputUiInfo": {}
          },
          "displayName": "Branch",
          "onFailureAction": {
            "name": "step_16",
            "type": "PIECE",
            "valid": true,
            "settings": {
              "input": {
                "auth": "{{connections['ichiba-pipedrive']}}",
                "term": "{{step_1['workspace_id']}}",
                "limit": "10",
                "fields": "custom_fields",
                "exact_match": true
              },
              "pieceName": "@tuyendaovan6789/piece-pipedrive",
              "actionName": "search_lead",
              "inputUiInfo": {},
              "pieceVersion": "~0.3.13"
            },
            "nextAction": {
              "name": "step_17",
              "type": "CODE",
              "valid": true,
              "settings": {
                "input": {
                  "items": "{{step_16['items']}}"
                },
                "inputUiInfo": {},
                "artifact": "UEsDBAoAAAAAAGWPM1dHpmHKTwAAAE8AAAAIAAAAaW5kZXgudHNleHBvcnQgY29uc3QgY29kZSA9IGFzeW5jIChpbnB1dHMpID0+IHsKICAgIHJldHVybiBpbnB1dHMuaXRlbXMubGVuZ3RoIHx8IDA7Cn07UEsDBAoAAAAAAGWPM1caUtEIHAAAABwAAAAMAAAAcGFja2FnZS5qc29uewogICJkZXBlbmRlbmNpZXMiOiB7CiAgfQp9ClBLAQIUAAoAAAAAAGWPM1dHpmHKTwAAAE8AAAAIAAAAAAAAAAAAAAAAAAAAAABpbmRleC50c1BLAQIUAAoAAAAAAGWPM1caUtEIHAAAABwAAAAMAAAAAAAAAAAAAAAAAHUAAABwYWNrYWdlLmpzb25QSwUGAAAAAAIAAgBwAAAAuwAAAAAA"
              },
              "nextAction": {
                "name": "step_18",
                "type": "BRANCH",
                "valid": true,
                "settings": {
                  "conditions": [
                    [
                      {
                        "operator": "NUMBER_IS_GREATER_THAN",
                        "firstValue": "{{step_17}}",
                        "secondValue": "0"
                      }
                    ]
                  ],
                  "inputUiInfo": {}
                },
                "displayName": "is exists lead",
                "onSuccessAction": {
                  "name": "step_19",
                  "type": "PIECE",
                  "valid": true,
                  "settings": {
                    "input": {
                      "id": "{{step_16['items'][0]['item']['id']}}",
                      "auth": "{{connections['ichiba-pipedrive']}}",
                      "label_ids": [],
                      "lead_contact_status": 312
                    },
                    "pieceName": "@tuyendaovan6789/piece-pipedrive",
                    "actionName": "update_lead",
                    "inputUiInfo": {},
                    "pieceVersion": "~0.3.13"
                  },
                  "displayName": "Update A Lead"
                }
              },
              "displayName": "count searched leads"
            },
            "displayName": "Search Leads"
          },
          "onSuccessAction": {
            "name": "step_2",
            "type": "PIECE",
            "valid": true,
            "settings": {
              "input": {
                "auth": "{{connections['ic-postgres']}}",
                "query": "SELECT\n    wu.workspace_id, us.email, ws.name as title, cs.name as country_name, com.name as company_name, com.address as company_address, com.company_size, com.company_type, (com.prefix_phone_number || ' ' || com.phone_number) as phone_number, p.code as workspace_owner\nFROM user_management.workspace_users wu\nINNER JOIN user_management.user_profiles us on wu.user_id = us.id AND wu.sharding_id = us.sharding_id\nINNER JOIN user_management.workspaces ws on wu.workspace_id = ws.id AND wu.sharding_id = ws.sharding_id\nINNER JOIN user_management.workspace_group_permissions p on wu.workspace_group_permission_id = p.id AND wu.sharding_id = p.sharding_id\nINNER JOIN user_management.countries cs on ws.country_code = cs.code AND ws.sharding_id = cs.sharding_id\nINNER JOIN (\n    SELECT\n        id, sharding_id, workspace_id, name, address, prefix_phone_number, phone_number\n        , CASE    WHEN company_type = 1 THEN 296\n                    WHEN company_type = 2 THEN 297\n                    WHEN company_type = 3 THEN 298\n                    WHEN company_type = 4 THEN 299\n                    WHEN company_type = 5 THEN 300\n                    ELSE null\n            END AS company_type\n        , CASE    WHEN company_síze = 1 THEN 301\n                    WHEN company_síze = 2 THEN 302\n                    WHEN company_síze = 3 THEN 303\n                    WHEN company_síze = 4 THEN 304\n                    WHEN company_síze = 5 THEN 305\n                    ELSE null\n            END AS company_size\n    FROM user_management.company_settings\n) com on ws.id = com.workspace_id AND ws.sharding_id = com.sharding_id\nWHERE wu.id = '{{step_1['id']}}' AND wu.sharding_id = '{{step_1['sharding_id']}}'\nLIMIT 1;",
                "query_timeout": "30000",
                "application_name": "activepieces-creation lead",
                "connection_timeout_ms": "30000"
              },
              "pieceName": "@activepieces/piece-postgres",
              "actionName": "run-query",
              "inputUiInfo": {},
              "pieceVersion": "~0.1.0"
            },
            "nextAction": {
              "name": "step_3",
              "type": "PIECE",
              "valid": true,
              "settings": {
                "input": {
                  "auth": "{{connections['ic-postgres']}}",
                  "query": "SELECT\n    a.app, a.code\nFROM user_management.workspace_users wu\nINNER JOIN user_management.subscriptions s on wu.workspace_id = s.workspace_id AND wu.sharding_id = s.sharding_id\nINNER JOIN user_management.plans p on s.plan_id = p.id AND s.sharding_id = p.sharding_id\nINNER JOIN (\n        SELECT\n            id, sharding_id, code,\n            CASE    WHEN code = 'ship4p' THEN 283\n                    WHEN code = 'oms' THEN 284\n                    WHEN code = 'customer' THEN 285\n                    WHEN code = 'cbf' THEN 286\n                    WHEN code = 'pos' THEN 306\n                    WHEN code = 'social' THEN 307\n                    WHEN code = 'pim' THEN 308\n                    WHEN code = 'cdxp' THEN 309\n                    WHEN code = 'wms' THEN 310\n                    WHEN code = 'digital' THEN 311\n            END AS app\n        FROM user_management.applications\n    ) a on p.application_id = a.id AND p.sharding_id = a.sharding_id\nWHERE wu.id = '{{step_1['id']}}' AND wu.sharding_id = '{{step_1['sharding_id']}}' AND s.status = true;",
                  "query_timeout": "30000",
                  "application_name": "activepieces-creation lead",
                  "connection_timeout_ms": "30000"
                },
                "pieceName": "@activepieces/piece-postgres",
                "actionName": "run-query",
                "inputUiInfo": {},
                "pieceVersion": "~0.1.0"
              },
              "nextAction": {
                "name": "step_20",
                "type": "PIECE",
                "valid": true,
                "settings": {
                  "input": {
                    "auth": "{{connections['ichiba-pipedrive']}}",
                    "term": "{{step_2[0]['email']}}",
                    "limit": "10",
                    "fields": "email",
                    "exact_match": true
                  },
                  "pieceName": "@tuyendaovan6789/piece-pipedrive",
                  "actionName": "search_person",
                  "inputUiInfo": {},
                  "pieceVersion": "~0.3.14"
                },
                "nextAction": {
                  "name": "step_5",
                  "type": "CODE",
                  "valid": true,
                  "settings": {
                    "input": {
                      "items": "{{step_20['items']}}"
                    },
                    "inputUiInfo": {},
                    "artifact": "UEsDBAoAAAAAAN2SM1cGs6XaUAAAAFAAAAAIAAAAaW5kZXgudHNleHBvcnQgY29uc3QgY29kZSA9IGFzeW5jIChpbnB1dHMpID0+IHsKICAgIHJldHVybiBpbnB1dHMuaXRlbXMubGVuZ3RoIHx8IDA7Cn07ClBLAwQKAAAAAADdkjNXGlLRCBwAAAAcAAAADAAAAHBhY2thZ2UuanNvbnsKICAiZGVwZW5kZW5jaWVzIjogewogIH0KfQpQSwECFAAKAAAAAADdkjNXBrOl2lAAAABQAAAACAAAAAAAAAAAAAAAAAAAAAAAaW5kZXgudHNQSwECFAAKAAAAAADdkjNXGlLRCBwAAAAcAAAADAAAAAAAAAAAAAAAAAB2AAAAcGFja2FnZS5qc29uUEsFBgAAAAACAAIAcAAAALwAAAAAAA=="
                  },
                  "nextAction": {
                    "name": "step_6",
                    "type": "BRANCH",
                    "valid": true,
                    "settings": {
                      "conditions": [
                        [
                          {
                            "operator": "NUMBER_IS_GREATER_THAN",
                            "firstValue": "{{step_5}}",
                            "secondValue": "0"
                          }
                        ]
                      ],
                      "inputUiInfo": {}
                    },
                    "displayName": "is exists person",
                    "onFailureAction": {
                      "name": "step_10",
                      "type": "PIECE",
                      "valid": true,
                      "settings": {
                        "input": {
                          "auth": "{{connections['ic-postgres']}}",
                          "query": "SELECT\n    up.full_name, up.email, up.phone_number, cs.name as country_name\nFROM user_management.user_profiles up\nINNER JOIN user_management.countries cs on up.country_code = cs.code AND up.sharding_id = cs.sharding_id\nWHERE up.id = '{{step_1['user_id']}}' AND up.sharding_id = '{{step_1['sharding_id']}}'\nLIMIT 1;",
                          "query_timeout": "30000",
                          "application_name": "activepieces - creation lead",
                          "connection_timeout_ms": "30000"
                        },
                        "pieceName": "@activepieces/piece-postgres",
                        "actionName": "run-query",
                        "inputUiInfo": {},
                        "pieceVersion": "~0.1.0"
                      },
                      "nextAction": {
                        "name": "step_9",
                        "type": "PIECE",
                        "valid": true,
                        "settings": {
                          "input": {
                            "auth": "{{connections['ichiba-pipedrive']}}",
                            "name": "{{step_10[0]['full_name']}}",
                            "email": "{{step_10[0]['email']}}",
                            "phone": "{{step_10[0]['phone_number']}}",
                            "source": "Org",
                            "country": "{{step_10[0]['country_name']}}"
                          },
                          "pieceName": "@tuyendaovan6789/piece-pipedrive",
                          "actionName": "add_person",
                          "inputUiInfo": {},
                          "pieceVersion": "~0.3.6"
                        },
                        "displayName": "add person"
                      },
                      "displayName": "get user detail"
                    },
                    "onSuccessAction": {
                      "name": "step_13",
                      "type": "PIECE",
                      "valid": true,
                      "settings": {
                        "input": {
                          "auth": "{{connections['ic-postgres']}}",
                          "query": "SELECT\n    ws.created_by\nFROM user_management.workspace_users wu\nINNER JOIN user_management.workspaces ws on wu.workspace_id = ws.id AND wu.sharding_id = ws.sharding_id\nWHERE wu.id = '{{step_1['id']}}' AND wu.sharding_id = '{{step_1['sharding_id']}}'\nLIMIT 1;",
                          "query_timeout": "30000",
                          "application_name": "activepieces - creation lead",
                          "connection_timeout_ms": "30000"
                        },
                        "pieceName": "@activepieces/piece-postgres",
                        "actionName": "run-query",
                        "inputUiInfo": {},
                        "pieceVersion": "~0.1.0"
                      },
                      "nextAction": {
                        "name": "step_14",
                        "type": "BRANCH",
                        "valid": true,
                        "settings": {
                          "conditions": [
                            [
                              {
                                "operator": "TEXT_CONTAINS",
                                "firstValue": "{{step_13[0]['created_by']}}",
                                "secondValue": "{{step_1['user_id']}}",
                                "caseSensitive": false
                              }
                            ]
                          ],
                          "inputUiInfo": {}
                        },
                        "displayName": "is creator workspace",
                        "onFailureAction": {
                          "name": "step_12",
                          "type": "PIECE",
                          "valid": true,
                          "settings": {
                            "input": {
                              "auth": "{{connections['ichiba-pipedrive']}}",
                              "term": "{{step_2[0]['workspace_id']}}",
                              "limit": "10",
                              "fields": "custom_fields",
                              "exact_match": true
                            },
                            "pieceName": "@tuyendaovan6789/piece-pipedrive",
                            "actionName": "search_lead",
                            "inputUiInfo": {},
                            "pieceVersion": "~0.3.15"
                          },
                          "nextAction": {
                            "name": "step_21",
                            "type": "BRANCH",
                            "valid": true,
                            "settings": {
                              "conditions": [
                                [
                                  {
                                    "operator": "NUMBER_IS_LESS_THAN",
                                    "firstValue": "{{step_12['items']}}",
                                    "secondValue": "1"
                                  }
                                ]
                              ],
                              "inputUiInfo": {}
                            },
                            "displayName": "is not exists lead",
                            "onFailureAction": {
                              "name": "step_22",
                              "type": "PIECE",
                              "valid": true,
                              "settings": {
                                "input": {
                                  "id": "{{step_12['items'][0]['item']['person']['id']}}",
                                  "auth": "{{connections['ichiba-pipedrive']}}"
                                },
                                "pieceName": "@tuyendaovan6789/piece-pipedrive",
                                "actionName": "get_detail_person",
                                "inputUiInfo": {},
                                "pieceVersion": "~0.3.15"
                              },
                              "nextAction": {
                                "name": "step_23",
                                "type": "PIECE",
                                "valid": true,
                                "settings": {
                                  "input": {
                                    "id": "{{step_20['items'][0]['item']['id']}}",
                                    "auth": "{{connections['ichiba-pipedrive']}}",
                                    "org_id": "{{step_22['org_id']['value']}}"
                                  },
                                  "pieceName": "@tuyendaovan6789/piece-pipedrive",
                                  "actionName": "update_person",
                                  "inputUiInfo": {},
                                  "pieceVersion": "~0.3.15"
                                },
                                "displayName": "update organization of this person"
                              },
                              "displayName": "get person is owner of this lead"
                            }
                          },
                          "displayName": "Search Leads"
                        },
                        "onSuccessAction": {
                          "name": "step_7",
                          "type": "CODE",
                          "valid": true,
                          "settings": {
                            "input": {
                              "apps": "{{step_3}}",
                              "person_id": "{{step_20['items'][0]['item']['id']}}",
                              "workspace_information": "{{step_2[0]}}"
                            },
                            "inputUiInfo": {},
                            "artifact": "UEsDBAoAAAAAAICTM1fXQUl4zQMAAM0DAAAIAAAAaW5kZXgudHNleHBvcnQgY29uc3QgY29kZSA9IGFzeW5jIChpbnB1dHMpID0+IHsNCiAgICBsZXQgcHJvZHVjdF9pbnRlcmVzdCA9ICIiOw0KICAgIGxldCBub19hcHBsaWNhdGlvbiA9IDA7DQogICAgaWYgKGlucHV0cy5hcHBzICE9IG51bGwgJiYgaW5wdXRzLmFwcHMubGVuZ3RoID4gMCkgew0KICAgICAgICBub19hcHBsaWNhdGlvbiA9IGlucHV0cy5hcHBzLmxlbmd0aDsNCiAgICAgICAgcHJvZHVjdF9pbnRlcmVzdCA9IGlucHV0cy5hcHBzLm1hcCh4ID0+IHguYXBwKS5qb2luKCk7DQogICAgfQ0KDQogICAgcmV0dXJuIHsNCiAgICAgICAgInRpdGxlIjogaW5wdXRzLndvcmtzcGFjZV9pbmZvcm1hdGlvbi50aXRsZSwNCiAgICAgICAgInBlcnNvbl9pZCI6IGlucHV0cy5wZXJzb25faWQsDQogICAgICAgICJ3b3Jrc3BhY2VfaWQiOiBpbnB1dHMud29ya3NwYWNlX2luZm9ybWF0aW9uLndvcmtzcGFjZV9pZCwNCiAgICAgICAgImNvbXBhbnlfY291bnRyeSI6IGlucHV0cy53b3Jrc3BhY2VfaW5mb3JtYXRpb24uY291bnRyeV9uYW1lLA0KICAgICAgICAiY29tcGFueV9hZGRyZXNzIjogaW5wdXRzLndvcmtzcGFjZV9pbmZvcm1hdGlvbi5jb21wYW55X2FkZHJlc3MsDQogICAgICAgICJjb21wYW55X25hbWUiOiBpbnB1dHMud29ya3NwYWNlX2luZm9ybWF0aW9uLmNvbXBhbnlfbmFtZSwNCiAgICAgICAgImNvbXBhbnlfdHlwZSI6IGlucHV0cy53b3Jrc3BhY2VfaW5mb3JtYXRpb24uY29tcGFueV90eXBlLA0KICAgICAgICAiY29tcGFueV9zaXplIjogaW5wdXRzLndvcmtzcGFjZV9pbmZvcm1hdGlvbi5jb21wYW55X3NpemUsDQogICAgICAgICJwaG9uZV9udW1iZXIiOiBpbnB1dHMud29ya3NwYWNlX2luZm9ybWF0aW9uLnBob25lX251bWJlciwNCiAgICAgICAgIm5vX2FwcGxpY2F0aW9uIjogbm9fYXBwbGljYXRpb24sDQogICAgICAgICJwcm9kdWN0X2ludGVyZXN0IjogcHJvZHVjdF9pbnRlcmVzdA0KICAgIH07DQp9Ow0KUEsDBAoAAAAAAICTM1clU8RLHgAAAB4AAAAMAAAAcGFja2FnZS5qc29uew0KICAiZGVwZW5kZW5jaWVzIjogew0KICB9DQp9UEsBAhQACgAAAAAAgJMzV9dBSXjNAwAAzQMAAAgAAAAAAAAAAAAAAAAAAAAAAGluZGV4LnRzUEsBAhQACgAAAAAAgJMzVyVTxEseAAAAHgAAAAwAAAAAAAAAAAAAAAAA8wMAAHBhY2thZ2UuanNvblBLBQYAAAAAAgACAHAAAAA7BAAAAAA="
                          },
                          "nextAction": {
                            "name": "step_4",
                            "type": "PIECE",
                            "valid": true,
                            "settings": {
                              "input": {
                                "auth": "{{connections['ichiba-pipedrive']}}",
                                "title": "{{step_7['title']}}",
                                "label_ids": [
                                  "a22ff115-980b-4f6b-8f0a-fd6ca7e75f1d"
                                ],
                                "person_id": "{{step_7['person_id']}}",
                                "company_name": "{{step_7['company_name']}}",
                                "company_size": "{{step_7['company_size']}}",
                                "company_type": "{{step_7['company_type']}}",
                                "workspace_id": "{{step_7['workspace_id']}}",
                                "no_application": "{{step_7['no_application']}}",
                                "company_address": "{{step_7['company_address']}}",
                                "company_country": "{{step_7['company_country']}}",
                                "organization_id": "{{step_20['items'][0]['item']['organization']['id']}}",
                                "product_interest": "{{step_7['product_interest']}}",
                                "company_phone_number": "{{step_7['phone_number']}}"
                              },
                              "pieceName": "@tuyendaovan6789/piece-pipedrive",
                              "actionName": "add_lead",
                              "inputUiInfo": {},
                              "pieceVersion": "~0.3.14"
                            },
                            "nextAction": {
                              "name": "step_8",
                              "type": "BRANCH",
                              "valid": true,
                              "settings": {
                                "conditions": [
                                  [
                                    {
                                      "operator": "EXISTS",
                                      "firstValue": "{{step_4['id']}}"
                                    }
                                  ]
                                ],
                                "inputUiInfo": {}
                              },
                              "displayName": "is added lead successful",
                              "onSuccessAction": {
                                "name": "step_11",
                                "type": "PIECE",
                                "valid": true,
                                "settings": {
                                  "input": {
                                    "id": "{{step_20['items'][0]['item']['id']}}",
                                    "auth": "{{connections['ichiba-pipedrive']}}",
                                    "label": 5
                                  },
                                  "pieceName": "@tuyendaovan6789/piece-pipedrive",
                                  "actionName": "update_person",
                                  "inputUiInfo": {},
                                  "pieceVersion": "~0.3.15"
                                },
                                "displayName": "update label of this person"
                              }
                            },
                            "displayName": "Add A Lead"
                          },
                          "displayName": "build payload"
                        }
                      },
                      "displayName": "get creator workspace"
                    }
                  },
                  "displayName": "count person searched"
                },
                "displayName": "Search Persons"
              },
              "displayName": "get apps"
            },
            "displayName": "get workspace information"
          }
        },
        "displayName": "parse json value"
      },
      "type": "WEBHOOK",
      "settings": {
        "inputUiInfo": {}
      }
    },
    "valid": true
  }
}